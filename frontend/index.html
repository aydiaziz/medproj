<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reconnaissance signes ‚Äî MediaPipe Hands</title>
    <style>
      /* Modern, readable UI with detection display */
      html,body{height:100%;margin:0}
      body{display:flex;align-items:center;justify-content:center;background:#f5f7fb;font-family:system-ui,Segoe UI,Roboto,Arial;color:#082032}
      .wrap{width:100%;max-width:1000px;padding:24px;text-align:center}
      .box{background:white;padding:36px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
      .text{font-size:48px;font-weight:700;line-height:1.05;margin:0 0 12px}
      .muted{font-size:16px;color:#6b7280;margin:0}
      .detection-info{background:#f0f7ff;padding:16px;border-radius:8px;margin:16px 0;border-left:4px solid #0066cc;text-align:left;font-size:14px;font-family:monospace}
      .detection-info strong{color:#0066cc}
      .hand-card{background:#fff8f0;padding:12px;border-radius:8px;margin:8px 0;border:1px solid #ffe0cc;text-align:left}
      .hand-label{font-weight:600;color:#d97706;margin-bottom:8px}
      .landmarks-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:6px;font-size:11px}
      .landmark-point{background:white;padding:6px;border-radius:4px;border:1px solid #ccc}
      .landmark-point code{color:#0066cc;font-weight:600;display:block}
      @media (max-width:520px){.text{font-size:28px;padding:0 6px}}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="box">
        <!-- Title -->
        <h1 style="font-size:32px;margin:0 0 24px;color:#0066cc">ü§ñ D√©tecteur de Signes</h1>

        <!-- Live camera preview -->
        <div style="display:flex;justify-content:center;margin-bottom:20px">
          <div id="preview-container" style="width:100%;max-width:640px;height:360px;border-radius:8px;background:#000;border:2px solid #0066cc;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;">
            Cam√©ra utilis√©e par le serveur pour la d√©tection
          </div>
        </div>

        <!-- Detection status and hand count -->
        <div id="detection-status" class="text" style="color:#0066cc;font-size:32px;margin:12px 0;">0 mains d√©tect√©es</div>

        <!-- Recognized text display -->
        <div id="recognized-text" class="text" style="color:#0b5;font-size:36px;margin:12px 0;min-height:48px;display:flex;align-items:center;justify-content:center;background:#f0fff0;border-radius:8px;border:2px solid #0b5;padding:12px;">En attente de signes...</div>

        <!-- Detection details: hands and landmarks -->
        <div id="detection-details" style="margin:20px 0;display:none">
          <div id="hands-container"></div>
        </div>

        <!-- Timestamps and stats -->
        <div class="detection-info" id="stats-info" style="display:none;">
          <strong>Frames trait√©es:</strong> <span id="frame-count">0</span><br/>
          <strong>Derni√®re mise √† jour:</strong> <span id="last-update">‚Äî</span>
        </div>

        <!-- Controls: start/stop detection -->
        <div style="margin-top:20px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <button id="startBtn" aria-label="Start detection" style="padding:12px 20px;border-radius:8px;border:none;cursor:pointer;background:#0b5;color:white;font-weight:600">‚ñ∂ D√©marrer d√©tection</button>
          <button id="stopBtn" aria-label="Stop detection" style="padding:12px 20px;border-radius:8px;border:1px solid #ccc;cursor:pointer;background:#fff;color:#082032;font-weight:600">‚èπ Arr√™ter d√©tection</button>
        </div>

        <!-- Connection status -->
        <p id="status" class="muted" style="margin-top:16px;color:#6b7280">Connexion au serveur...</p>
        <p style="font-size:12px;color:#999;margin:8px 0">La cam√©ra est utilis√©e par le serveur pour la d√©tection en temps r√©el</p>
      </div>
    </div>

    <script>
      // WebSocket client displaying MediaPipe Hands landmarks in real-time
      (function(){
        const WS_URL = 'ws://localhost:8000/ws';
        const detectionStatusEl = document.getElementById('detection-status');
        const recognizedTextEl = document.getElementById('recognized-text');
        const handsContainerEl = document.getElementById('hands-container');
        const detectionDetailsEl = document.getElementById('detection-details');
        const statusEl = document.getElementById('status');
        const frameCountEl = document.getElementById('frame-count');
        const lastUpdateEl = document.getElementById('last-update');
        const statsInfoEl = document.getElementById('stats-info');

        let ws = null;
        let running = false;
        
        // Fonction de log
        function log(message) {
          console.log(`[FRONTEND] ${new Date().toISOString()} - ${message}`);
        }

        // Update status message
        function setStatus(s){ 
          log(`Status: ${s}`);
          statusEl.textContent = s; 
        }

        // Format timestamp nicely
        function formatTime(isoStr){
          try{
            const d = new Date(isoStr);
            return d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
          }catch(e){
            return isoStr;
          }
        }

        // Format landmark coordinates (rounded to 3 decimals)
        function formatCoord(x){ return parseFloat(x).toFixed(3); }

        // Render hand landmarks as a visual grid
        function renderHandLandmarks(hand, handIndex){
          const card = document.createElement('div');
          card.className = 'hand-card';
          
          // Hand label and confidence
          const label = document.createElement('div');
          label.className = 'hand-label';
          const confidence = (hand.confidence * 100).toFixed(1);
          label.textContent = `${hand.label === 'Left' ? 'üëà' : 'üëâ'} ${hand.label} (${confidence}%)`;
          card.appendChild(label);
          
          // Landmarks grid
          const grid = document.createElement('div');
          grid.className = 'landmarks-grid';
          
          // Show first 5 landmarks as samples (for brevity)
          const landmarkNames = [
            'Wrist', 'Thumb CMC', 'Thumb MCP', 'Thumb IP', 'Thumb Tip',
            'Index MCP', 'Index PIP', 'Index DIP', 'Index Tip', 'Middle MCP'
          ];
          
          hand.landmarks.forEach((lm, i) => {
            const point = document.createElement('div');
            point.className = 'landmark-point';
            point.innerHTML = `<code>L${i}</code><small>x:${formatCoord(lm.x)}<br/>y:${formatCoord(lm.y)}</small>`;
            grid.appendChild(point);
          });
          
          card.appendChild(grid);
          return card;
        }

        // Update detection display from WebSocket message
        function updateDetection(data){
          if(!data || !data.detection){ return; }
          
          const detection = data.detection;
          const numHands = detection.num_hands || 0;
          
          // Update hand count display
          const handText = numHands === 0 ? '0 mains d√©tect√©es' 
                         : numHands === 1 ? '1 main d√©tect√©e' 
                         : `${numHands} mains d√©tect√©es`;
          detectionStatusEl.textContent = handText;
          
          // Update hands container
          handsContainerEl.innerHTML = '';
          if(detection.hands && detection.hands.length > 0){
            detection.hands.forEach((hand, i) => {
              handsContainerEl.appendChild(renderHandLandmarks(hand, i));
            });
            detectionDetailsEl.style.display = 'block';
          } else {
            detectionDetailsEl.style.display = 'none';
          }
          
          // Update stats
          if(data.frames_total !== undefined){
            frameCountEl.textContent = data.frames_total;
            statsInfoEl.style.display = 'block';
          }
          if(data.timestamp){
            lastUpdateEl.textContent = formatTime(data.timestamp);
          }
        }

        // Establish WebSocket connection
        function connect(){
          log("Tentative de connexion WebSocket...");
          try{
            ws = new WebSocket(WS_URL);
          }catch(e){
            log(`Erreur cr√©ation WebSocket: ${e}`);
            setStatus('Impossible de connecter');
            return;
          }

          ws.onopen = function(){ 
            log("WebSocket connect√©");
            setStatus('Connect√© ‚úì');
          };

          ws.onmessage = function(evt){
            try{
              const data = JSON.parse(evt.data);
              
              // Handle recognized text messages
              if(data.type === 'recognized_text' && data.text){
                log(`Signe reconnu: ${data.text}`);
                recognizedTextEl.textContent = data.text;
                recognizedTextEl.style.background = '#e6fffa';
                recognizedTextEl.style.borderColor = '#0b5';
                setTimeout(() => {
                  recognizedTextEl.style.background = '#f0fff0';
                  recognizedTextEl.style.borderColor = '#0b5';
                }, 3000);
              }
              
              // Only update display when running
              if(running){
                updateDetection(data);
              }
            }catch(err){
              log(`Erreur parsing: ${err}`);
            }
          };

          ws.onerror = function(err){
            log(`Erreur WebSocket: ${err}`);
            setStatus('Erreur de connexion');
          };

          ws.onclose = function(ev){
            log("WebSocket ferm√©, reconnexion...");
            setStatus('D√©connect√© ‚Äî Reconnexion...');
            setTimeout(connect, 2000);
          };
        }

        // Initialize on page load
        window.addEventListener('load', function(){
          connect();
          setStatus('Pr√™t');
          
          // Wire buttons
          const startBtn = document.getElementById('startBtn');
          const stopBtn = document.getElementById('stopBtn');
          
          startBtn.addEventListener('click', function(){
            log("D√©marrage d√©tection");
            running = true;
            setStatus('D√©tection en cours ‚ñ∂');
            detectionStatusEl.textContent = 'En attente de mains...';
            startBtn.disabled = true;
            stopBtn.disabled = false;
          });
          
          stopBtn.addEventListener('click', function(){
            log("Arr√™t d√©tection");
            running = false;
            setStatus('D√©tection arr√™t√©e');
            detectionStatusEl.textContent = '0 mains d√©tect√©es';
            detectionDetailsEl.style.display = 'none';
            statsInfoEl.style.display = 'none';
            startBtn.disabled = false;
            stopBtn.disabled = true;
          });
          
          // Initial button states
          startBtn.disabled = false;
          stopBtn.disabled = true;
          log("Boutons initialis√©s");
        });

        // Close socket cleanly on unload
        window.addEventListener('beforeunload', function(){ if(ws) try{ ws.close(); }catch(e){} });
      })();
    </script>
  </body>
</html>

